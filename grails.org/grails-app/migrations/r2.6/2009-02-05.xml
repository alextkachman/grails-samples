<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

    <!--
        Remove comments from BlogEntry and attach to Content instead.
    -->
    <changeSet author="rhyolight" id="2009-02-05:1">
        <renameColumn
                tableName="blog_entry_comment"
                oldColumnName="blog_entry_comments_id"
                newColumnName="parent_id"
                columnDataType="bigInt(20)"
        />
        <renameTable
                oldTableName="blog_entry_comment"
                newTableName="content_comment"
        />
    </changeSet>

    <!--
        As a part of comments, must add a parent id to the comment table to refer back to the content,
        this will allow searchability
    -->
    <changeSet author="rhyolight" id="2009-02-05:2">
        <addColumn tableName="comment">
            <column name="parent_id" type="bigint(20)"/>
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_comment_content"
             baseTableName="comment" baseColumnNames="parent_id"
             referencedTableName="content" referencedColumnNames="id"
        />
    </changeSet>

    <!--
        Add tables for Ranking and Tag
    -->
    <changeSet author="rhyolight" id="2009-02-05:3-1">
        <createTable tableName="rating">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="stars" type="TINYINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="tag">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!--
        Make modifications to the parent table Content for Plugin, because we're using
        table-per-heirarchy
    -->
    <changeSet author="rhyolight" id="2009-02-05:3-2">
        <!-- add columns for new Plugin attributes -->
        <addColumn tableName="content">
            <column name="description" type="TEXT"/>
            <column name="installation" type="TEXT"/>
            <column name="faq" type="TEXT"/>
            <column name="screenshots" type="TEXT"/>
            <column name="official" type="BOOLEAN"/>
        </addColumn>
        <!-- add a linking table for ratings -->
        <createTable tableName="plugin_rating">
            <column name="plugin_ratings_id" type="BIGINT(20)"/>
            <column name="rating_id" type="BIGINT(20)"/>
        </createTable>
        <addForeignKeyConstraint constraintName="fk_plugin_rating_plugin"
            baseTableName="plugin_rating" baseColumnNames="plugin_ratings_id"
            referencedTableName="plugin" referencedColumnNames="id"
        />
        <addForeignKeyConstraint constraintName="fk_plugin_rating_rating"
            baseTableName="plugin_rating" baseColumnNames="rating_id"
            referencedTableName="rating" referencedColumnNames="id"
        />
        <!-- add a linking table for tags -->
        <createTable tableName="plugin_tag">
            <column name="plugin_tags_id" type="BIGINT(20)"/>
            <column name="tag_id" type="BIGINT(20)"/>
        </createTable>
        <addForeignKeyConstraint constraintName="fk_plugin_tag_plugin"
            baseTableName="plugin_tag" baseColumnNames="plugin_tags_id"
            referencedTableName="plugin" referencedColumnNames="id"
        />
        <addForeignKeyConstraint constraintName="fk_plugin_tag_tag"
            baseTableName="plugin_tag" baseColumnNames="tag_id"
            referencedTableName="tag" referencedColumnNames="id"
        />
    </changeSet>

</databaseChangeLog>